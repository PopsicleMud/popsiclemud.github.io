<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Into the Odd // Character Sheet</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Special+Elite&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="app-container">
        <nav class="nav-bar">
            <div class="char-controls">
                <select id="charList" onchange="switchCharacter()"></select>
                <button onclick="addCharacter()">+ New</button>
                <button onclick="randomizeCharacter()" title="Generate Random Character">ðŸŽ²</button>
            </div>
            <div class="file-controls">
                <button onclick="exportData()">Export</button>
                <button onclick="document.getElementById('importFile').click()">Import</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(event)">
                <button onclick="toggleManager(true)" class="primary">Manage</button>
            </div>
        </nav>

        <main class="sheet" id="sheetBody">
            <header>
                <input type="text" id="charName" placeholder="NAMELESS EXPLORER"
                    oninput="updateField('name', this.value)">
                <div class="exp-container">
                    <label for="experience">Experience</label>
                    <select id="experience" onchange="updateField('experience', this.value)">
                        <option value="Novice">Novice (0 XP)</option>
                        <option value="Professional">Professional (1 XP)</option>
                        <option value="Veteran">Veteran (3 XP)</option>
                        <option value="Master">Master (10 XP)</option>
                        <option value="Legend">Legend (25 XP)</option>
                    </select>
                </div>
            </header>

            <div class="stats-row">
                <div class="stat-box">
                    <label>Strength</label>
                    <div class="stat-inputs">
                        <input type="number" id="strCur" placeholder="10" oninput="updateField('strCur', this.value)">
                        <span>/</span>
                        <input type="number" id="strMax" placeholder="10" oninput="updateField('strMax', this.value)">
                    </div>
                </div>
                <div class="stat-box">
                    <label>Dexterity</label>
                    <div class="stat-inputs">
                        <input type="number" id="dexCur" placeholder="10" oninput="updateField('dexCur', this.value)">
                        <span>/</span>
                        <input type="number" id="dexMax" placeholder="10" oninput="updateField('dexMax', this.value)">
                    </div>
                </div>
                <div class="stat-box">
                    <label>Willpower</label>
                    <div class="stat-inputs">
                        <input type="number" id="wilCur" placeholder="10" oninput="updateField('wilCur', this.value)">
                        <span>/</span>
                        <input type="number" id="wilMax" placeholder="10" oninput="updateField('wilMax', this.value)">
                    </div>
                </div>
            </div>

            <div class="vitals-row">
                <div class="vital-box">
                    <label>Hit Points</label>
                    <div class="hp-inputs">
                        <input type="number" id="hpCur" placeholder="3" oninput="updateField('hpCur', this.value)">
                        <span>/</span>
                        <input type="number" id="hpMax" placeholder="3" oninput="updateField('hpMax', this.value)">
                    </div>
                </div>
                <div class="vital-box">
                    <label>Armor</label>
                    <input type="number" id="armor" placeholder="0"
                        style="width: 50px; text-align: center; font-size: 2rem; border: none; background: transparent; font-family: var(--font-mono);"
                        oninput="updateField('armor', this.value)">
                </div>
            </div>

            <div class="section-header">Weapons</div>
            <div class="weapons-grid" id="weaponsGrid">
                <!-- 3 Weapon slots will be generated here -->
            </div>

            <div class="section-header">Arcana</div>
            <textarea id="arcana" class="arcana-area" placeholder="Spells, artifacts, and mysterious items..."
                oninput="updateField('arcana', this.value)"></textarea>

            <div class="section-header">Inventory</div>
            <div class="inventory-grid" id="inventoryGrid">
                <!-- Slots 1-10 will be generated here -->
            </div>

            <div class="section-header">Notes & Background</div>
            <textarea id="notes" class="notes-area"
                placeholder="Character background, allies, enemies, and other details..."
                oninput="updateField('notes', this.value)"></textarea>
        </main>
    </div>

    <!-- Character Manager Modal -->
    <div class="modal-overlay" id="managerModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Character Roster</h2>
                <button class="close-modal" onclick="toggleManager(false)">&times;</button>
            </div>
            <ul class="char-manage-list" id="manageList">
                <!-- Character items will be generated here -->
            </ul>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal" style="display: none;">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
            </div>
            <p id="confirmMessage" style="padding: 1rem; text-align: center; font-size: 1.1rem;"></p>
            <div style="display: flex; gap: 1rem; padding: 0 1rem 1rem 1rem; justify-content: center;">
                <button onclick="confirmDelete(true)" class="primary" style="flex: 1;">Yes, Delete</button>
                <button onclick="confirmDelete(false)" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let state = {
            characters: [],
            currentIndex: 0
        };

        const STORAGE_KEY = 'ito_app_state';
        let pendingDeleteIndex = -1;

        // --- Core Logic ---

        function generateId() {
            return Date.now() + '-' + Math.floor(Math.random() * 1000000);
        }

        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                state = JSON.parse(saved);
                let needsSave = false;
                // Migrations
                state.characters.forEach(c => {
                    if (c.str && !c.strMax) {
                        c.strCur = c.str; c.strMax = c.str;
                        c.dexCur = c.dex; c.dexMax = c.dex;
                        c.wilCur = c.wil; c.wilMax = c.wil;
                        delete c.str; delete c.dex; delete c.wil;
                        needsSave = true;
                    }
                    if (typeof c.inventory === 'string') {
                        const oldInv = c.inventory;
                        c.inventory = Array(10).fill(null).map(() => ({ name: "", bulky: false }));
                        c.notes = (c.notes || "") + (oldInv ? "\n\nOld Inventory:\n" + oldInv : "");
                        needsSave = true;
                    }
                    if (Array.isArray(c.inventory) && typeof c.inventory[0] === 'string') {
                        c.inventory = c.inventory.map(item => ({ name: item || "", bulky: false }));
                        needsSave = true;
                    }
                    if (c.experience === undefined) { c.experience = "Novice"; needsSave = true; }
                    if (c.weapons === undefined) {
                        c.weapons = Array(3).fill(null).map(() => ({ name: "", damage: "", bulky: false }));
                        needsSave = true;
                    }
                    if (c.arcana === undefined) { c.arcana = ""; needsSave = true; }
                    if (c.notes === undefined) { c.notes = ""; needsSave = true; }
                    if (!c.id) { c.id = generateId(); needsSave = true; }
                });
                if (needsSave) save();
            } else {
                state.characters = [createDefaultChar()];
                state.currentIndex = 0;
                save();
            }
            renderWeaponSlots();
            renderInventorySlots();
            renderCharList();
            loadCurrentCharacter();
        }

        function createDefaultChar() {
            return {
                id: generateId(),
                name: "New Explorer",
                experience: "Novice",
                strCur: 10, strMax: 10,
                dexCur: 10, dexMax: 10,
                wilCur: 10, wilMax: 10,
                hpCur: 3, hpMax: 3,
                armor: 0,
                weapons: Array(3).fill(null).map(() => ({ name: "", damage: "", bulky: false })),
                arcana: "",
                inventory: Array(10).fill(null).map(() => ({ name: "", bulky: false })),
                notes: ""
            };
        }

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function renderWeaponSlots() {
            const grid = document.getElementById('weaponsGrid');
            grid.innerHTML = "";
            for (let i = 0; i < 3; i++) {
                const slot = document.createElement('div');
                slot.className = 'weapon-slot';
                slot.id = `weapon-container-${i}`;
                slot.innerHTML = `
                    <input type="text" id="weapon-name-${i}" placeholder="Weapon Name" oninput="updateWeapon(${i}, 'name', this.value)">
                    <div class="weapon-damage">
                        <label>Dmg</label>
                        <input type="text" id="weapon-damage-${i}" placeholder="d6" oninput="updateWeapon(${i}, 'damage', this.value)">
                    </div>
                    <label class="bulky-check">
                        <input type="checkbox" id="weapon-bulky-${i}" onchange="updateWeapon(${i}, 'bulky', this.checked)">
                        Bulky
                    </label>
                `;
                grid.appendChild(slot);
            }
        }

        function renderInventorySlots() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = "";
            for (let i = 0; i < 10; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.id = `slot-container-${i}`;
                slot.innerHTML = `
                    <span class="slot-num">${i + 1}</span>
                    <input type="text" id="slot-name-${i}" oninput="updateInventory(${i}, 'name', this.value)">
                    <label class="bulky-check">
                        <input type="checkbox" id="slot-bulky-${i}" onchange="updateInventory(${i}, 'bulky', this.checked)">
                        Bulky
                    </label>
                `;
                grid.appendChild(slot);
            }
        }

        function renderCharList() {
            const list = document.getElementById('charList');
            list.innerHTML = state.characters.map((c, i) =>
                `<option value="${i}" ${i === state.currentIndex ? 'selected' : ''}>${c.name || 'Unnamed'}</option>`
            ).join('');
        }

        function loadCurrentCharacter() {
            const c = state.characters[state.currentIndex];
            if (!c) return;

            document.getElementById('charName').value = c.name;
            document.getElementById('experience').value = c.experience || "Novice";
            document.getElementById('strCur').value = c.strCur;
            document.getElementById('strMax').value = c.strMax;
            document.getElementById('dexCur').value = c.dexCur;
            document.getElementById('dexMax').value = c.dexMax;
            document.getElementById('wilCur').value = c.wilCur;
            document.getElementById('wilMax').value = c.wilMax;
            document.getElementById('hpCur').value = c.hpCur;
            document.getElementById('hpMax').value = c.hpMax;
            document.getElementById('armor').value = c.armor;
            document.getElementById('arcana').value = c.arcana || "";
            document.getElementById('notes').value = c.notes || "";

            for (let i = 0; i < 3; i++) {
                const w = c.weapons[i] || { name: "", damage: "", bulky: false };
                document.getElementById(`weapon-name-${i}`).value = w.name;
                document.getElementById(`weapon-damage-${i}`).value = w.damage;
                document.getElementById(`weapon-bulky-${i}`).checked = w.bulky;
                const container = document.getElementById(`weapon-container-${i}`);
                if (w.bulky) container.classList.add('is-bulky');
                else container.classList.remove('is-bulky');
            }

            for (let i = 0; i < 10; i++) {
                const item = c.inventory[i] || { name: "", bulky: false };
                document.getElementById(`slot-name-${i}`).value = item.name;
                document.getElementById(`slot-bulky-${i}`).checked = item.bulky;
                const container = document.getElementById(`slot-container-${i}`);
                if (item.bulky) container.classList.add('is-bulky');
                else container.classList.remove('is-bulky');
            }

            const sheet = document.getElementById('sheetBody');
            sheet.style.animation = 'none';
            sheet.offsetHeight;
            sheet.style.animation = null;
        }

        function updateField(field, value) {
            state.characters[state.currentIndex][field] = value;
            if (field === 'name') {
                document.getElementById('charList').options[state.currentIndex].text = value || 'Unnamed';
            }
            save();
        }

        function updateWeapon(index, field, value) {
            state.characters[state.currentIndex].weapons[index][field] = value;
            if (field === 'bulky') {
                const container = document.getElementById(`weapon-container-${index}`);
                if (value) container.classList.add('is-bulky');
                else container.classList.remove('is-bulky');
            }
            save();
        }

        function updateInventory(index, field, value) {
            state.characters[state.currentIndex].inventory[index][field] = value;
            if (field === 'bulky') {
                const container = document.getElementById(`slot-container-${index}`);
                if (value) container.classList.add('is-bulky');
                else container.classList.remove('is-bulky');
            }
            save();
        }

        function switchCharacter() {
            state.currentIndex = parseInt(document.getElementById('charList').value);
            save();
            loadCurrentCharacter();
        }

        function addCharacter() {
            state.characters.push(createDefaultChar());
            state.currentIndex = state.characters.length - 1;
            save();
            renderCharList();
            loadCurrentCharacter();
        }

        // --- Character Manager Logic ---

        function toggleManager(show) {
            const modal = document.getElementById('managerModal');
            modal.style.display = show ? 'flex' : 'none';
            if (show) renderManageList();
        }

        function renderManageList() {
            const list = document.getElementById('manageList');
            list.innerHTML = state.characters.map((c) => `
                <li class="char-manage-item">
                    <span class="char-manage-name">${c.name || 'Unnamed Explorer'}</span>
                    <div class="char-manage-actions">
                        <button class="btn-delete-small" onclick="deleteCharFromManager('${c.id}')">Delete</button>
                    </div>
                </li>
            `).join('');
        }

        function deleteCharFromManager(id) {
            console.log("Attempting to delete character with ID:", id);
            if (state.characters.length <= 1) {
                alert("Keep at least one explorer.");
                return;
            }

            const index = state.characters.findIndex(c => String(c.id) === String(id));
            console.log("Found index:", index);

            if (index === -1) {
                console.error("Character not found for ID:", id);
                return;
            }

            pendingDeleteIndex = index;
            const charName = state.characters[index].name || 'this explorer';
            document.getElementById('confirmMessage').textContent = `Abandon ${charName} to the Odd?`;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function confirmDelete(confirmed) {
            document.getElementById('confirmModal').style.display = 'none';

            if (confirmed && pendingDeleteIndex !== -1) {
                const index = pendingDeleteIndex;
                const isDeletingCurrent = (index === state.currentIndex);

                state.characters.splice(index, 1);

                if (isDeletingCurrent) {
                    state.currentIndex = Math.max(0, index - 1);
                } else if (index < state.currentIndex) {
                    state.currentIndex--;
                }

                save();
                renderCharList();
                renderManageList();
                loadCurrentCharacter();
            }

            pendingDeleteIndex = -1;
        }

        // --- Randomizer ---

        function d6() { return Math.floor(Math.random() * 6) + 1; }
        function roll3d6() { return d6() + d6() + d6(); }

        function randomizeCharacter() {
            const c = state.characters[state.currentIndex];
            c.strMax = roll3d6(); c.strCur = c.strMax;
            c.dexMax = roll3d6(); c.dexCur = c.dexMax;
            c.wilMax = roll3d6(); c.wilCur = c.wilMax;
            c.hpMax = d6(); c.hpCur = c.hpMax;
            c.experience = "Novice";

            const weapons = [
                { name: "Sword", dmg: "d6" }, { name: "Bow", dmg: "d6" },
                { name: "Club", dmg: "d6" }, { name: "Pistol", dmg: "d6" }
            ];
            const tools = ["Lantern & Oil", "Rope (10m)", "Crowbar", "Caltrops"];

            c.weapons = Array(3).fill(null).map(() => ({ name: "", damage: "", bulky: false }));
            const randWep = weapons[Math.floor(Math.random() * weapons.length)];
            c.weapons[0] = { name: randWep.name, damage: randWep.dmg, bulky: false };

            c.inventory = Array(10).fill(null).map(() => ({ name: "", bulky: false }));
            c.inventory[0].name = tools[Math.floor(Math.random() * tools.length)];
            c.inventory[1].name = "Rations";

            c.arcana = "";
            c.notes = "";

            save();
            loadCurrentCharacter();
        }

        // --- Import / Export ---

        function exportData() {
            const blob = new Blob([JSON.stringify(state)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ito_roster_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.characters) {
                        state = imported;
                        state.characters.forEach(c => {
                            if (typeof c.inventory === 'string') {
                                const oldInv = c.inventory;
                                c.inventory = Array(10).fill(null).map(() => ({ name: "", bulky: false }));
                                c.notes = (c.notes || "") + (oldInv ? "\n\nOld Inventory:\n" + oldInv : "");
                            }
                            if (Array.isArray(c.inventory) && typeof c.inventory[0] === 'string') {
                                c.inventory = c.inventory.map(item => ({ name: item || "", bulky: false }));
                            }
                            if (c.experience === undefined) c.experience = "Novice";
                            if (c.weapons === undefined) {
                                c.weapons = Array(3).fill(null).map(() => ({ name: "", damage: "", bulky: false }));
                            }
                            if (c.arcana === undefined) c.arcana = "";
                            if (!c.id) c.id = generateId();
                        });
                        save();
                        renderCharList();
                        loadCurrentCharacter();
                    }
                } catch (err) {
                    alert("Invalid save file.");
                }
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>

</html>